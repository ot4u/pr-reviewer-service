# PR Reviewer Service

Сервис для автоматического назначения ревьюверов на Pull Request’ы (PR) внутри команд разработчиков.  
Реализован на Go с поддержкой REST API и PostgreSQL. Сервис позволяет создавать команды, управлять пользователями, создавать PR и автоматически назначать до двух ревьюверов на каждый PR.

---

## Обзор

Сервис автоматизирует назначение ревьюверов и поддерживает:

1. Создание команд
2. Создание пользователей и управление их активностью
3. Создание Pull Request’ов
4. Автоматическое назначение до 2-х ревьюверов на PR
5. Переназначение ревьюверов
6. Изменение статуса PR на MERGED (идемпотентное)
7. Получение PR, назначенных конкретному пользователю
8. Получение статистики (количество назначений по пользователям и по PR)
9. Деактивации пользователей команды и безопасная переназначаемость открытых PR

---

## Основная логика

### Автоматическое назначение ревьюверов

При создании PR:

- До двух активных пользователей из команды автора назначаются автоматически
- Автор PR не включается в назначение
- Если активен только один пользователь, назначается один ревьювер
- Если активных пользователей нет, PR создается без назначенных ревьюверов

---

### Переназначение ревьюверов

- Заменяет одного ревьювера на случайного активного участника его команды
- Работает только для PR со статусом `OPEN`
- После `MERGED` назначение невозможно

---

### Изменить статус PR на `MERGED`

- Полностью идемпотентная операция  
- Повторные вызовы не вызывают ошибок  
- Ответ всегда возвращает актуальное состояние PR

### Деактивация всех пользователей команды

- Меняет статус пользователей  
- Безопасно переназначает PR активным пользователям из другой команда  

---

## Технологический стек

- **Go** — реализация сервиса  
- **PostgreSQL** — база данных  
- **Docker / Docker Compose** — контейнеризация и оркестрация  
- **Echo** — высокопроизводительный HTTP фреймворк для Go 
- **SQLC** — работа с БД  
- **Unit, E2E, Integration тесты**  
- **Vegeta** — нагрузочное тестирование

---

## Структура проекта

```
├── cmd
│   └── main.go
├── internal/
│   ├── config/
│   ├── handler/
│   ├── repository/
│   ├── usecase/
│   ├── database/
│   └── domain/
├── tests/
│   └── load/
│   ├── unit/
│   ├── integration/
│   ├── e2e/
├── docker-compose.yml
├── Dockerfile
├── openapi.yaml
├── Makefile
└── README.md
```

---

## Установка и запуск

Локальный запуск:

1. Клонируйте репозиторий:
```bash
git clone https://github.com/ot4u/pr-reviewer-service.git
cd pr-reviewer-service
```

2. Запустите сервис 
Сервис будет доступен по адресу:
```bash
make run
```

Сервис будет доступен по адресу: http://localhost:8080.

Миграции применяются автоматически при старте.

---

## Переменные окружения

| Переменная     | Описание                         | По умолчанию |
|----------------|---------------------------------|--------------|
| DB_HOST        | Хост базы данных                 | postgres |
| DB_PORT        | Порт базы данных                 | 5432 |
| DB_USER        | Пользователь базы данных         | postgres |
| DB_PASSWORD    | Пароль базы данных               | password |
| DB_NAME        | Имя базы данных                  | pr_reviewer |
| SERVER_PORT    | Порт сервиса                     | 8080 |

---

## Эндпоинты API

### POST `/team/add`

- Создать команду с участниками (создаёт/обновляет пользователей)

- Пример запроса:
```bash
{
curl -X POST http://localhost:8080/team/add \
  -H "Content-Type: application/json" \
  -d '{
    "team_name": "backend",
    "members": [
      {"user_id": "u1", "username": "Alice", "is_active": true},
      {"user_id": "u2", "username": "Bob", "is_active": true}
    ]
  }'
}
```

- Пример ответа:
```json
{
  "team": {
    "team_name": "backend",
    "members": [
      {"user_id": "u1", "username": "Alice", "is_active": true},
      {"user_id": "u2", "username": "Bob", "is_active": true}
    ]
  }
}
```

---

### GET `/team/get`

- Получить информацию о команде.

- Пример запроса:
```bash
  curl -X GET "http://localhost:8080/team/get?team_name=backend"
```

- Пример ответа:
```json
{
  "team_name": "backend",
  "members": [
    {"user_id": "u1", "username": "Alice", "is_active": true},
    {"user_id": "u2", "username": "Bob", "is_active": true}
  ]
}
```
---

### POST `/team/deactivate`

- Массовая деактивация пользователей команды с безопасным переназначением PR.

- Пример запроса:
```bash
curl -X POST http://localhost:8080/team/deactivate \
  -H "Content-Type: application/json" \
  -d '{"team_name": "backend"}'
```

- Пример ответа:
```json
{
  "team_name": "backend",
  "deactivated_users": 5,
  "reassigned_prs": 3,
  "failed_reassignments": 0,
  "deactivated_user_ids": ["user1", "user2", "user3", "user4", "user5"]
}
```
---

### POST `/users/setIsActive`

- Установить флаг активности пользователя.

- Пример запроса:
```bash
curl -X POST http://localhost:8080/users/setIsActive \
  -H "Content-Type: application/json" \
  -d '{"user_id": "u2", "is_active": false}'
```

- Пример ответа:
```json
{
  "user": {
    "user_id": "u2",
    "username": "Bob",
    "team_name": "backend",
    "is_active": false
  }
}
```
---

### GET `/users/getReview`

- Получить PR, назначенные пользователю.

- Пример запроса:
```bash
curl -X GET "http://localhost:8080/users/getReview?user_id=u2"
```

- Пример ответа:
```json
{
  "user_id": "u2",
  "pull_requests": [
    {
      "pull_request_id": "pr-1001",
      "pull_request_name": "Add search",
      "author_id": "u1",
      "status": "OPEN"
    }
  ]
}
```

**POST** `/pullRequest/create` - Создать PR и автоматически назначить до 2 ревьюверов из команды автора.
**POST** `/pullRequest/merge` - Пометить PR как MERGED (идемпотентная операция).
**POST** `/pullRequest/reassign` - Переназначить ревьювера на случайного активного пользователя из той же команды.
**GET** `/stats/reviews` - Получить статистику по количеству назначений на пользователей.
**GET** `/stats/pr-assignments` - Получить статистику по количеству ревьюверов на PR.
**GET** `/health` - Проверить доступность сервиса.
---

## Тестирование

### Запустить все тесты

```bash
make test
```

- unit тесты для проверки бизнес-логики(usecase слой)
- integration - repository, handler
- e2e - проверяет весь цикл работы сервиса

Результаты load testing (3 минуты, RPS=5):
```
=== Results ===
Requests: 900
Success rate: 99.7778%
Latency mean: 3.94997ms
Latency P95: 6.038616ms
Latency P99: 10.201624ms
```
---

## Архитектура

Применяется паттерн Clean-Architecture

- **Handler** — обработка HTTP-запросов, валидация, логирование  
- **Usecase** — бизнес-логика: назначение и переназначение ревьюверов, merge PR  
- **Repository** — работа с PostgreSQL  
- **DataBase** — миграции, запросы, схемы SQL  
- **Domain** — структуры данных (entities)

---

## Проблемы и решения

1. **Назначение ревьюверов при недостатке активных пользователей**  
   - Реализован безопасный fallback (назначение 0/1/2 в зависимости от доступности)

2. **Множественные merge-запросы**  
   - Сделан полностью идемпотентный merge

3. **SLI < 99.9% при нагрузочном тесте**  
   - Уменьшено количество небезопасных запросов и сбалансирован RPS

4. **Некорректные входные данные**  
   - Добавлены кастомные ошибки

5. **Логика безопасного переназначения PR при деактивации пользователей**
  - Переназначается активным пользователям из других команд 
---

## Заключение

Сервис обеспечивает стабильное, предсказуемое и высокопроизводительное назначение ревьюверов внутри команд.  
Все операции безопасны, распределение ревьюверов корректно, merge — идемпотентен.  

Система готова к дальнейшему расширению.

---

> **"Любую проблему можно решить, если разбить ее на достаточно мелкие части."**
> — Генри Форд